<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Fynd Feedback System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                <button
                    id="refreshBtn"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Analytics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">Total Reviews</div>
                <div class="text-3xl font-bold text-gray-800" id="totalReviews">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">Average Rating</div>
                <div class="text-3xl font-bold text-yellow-500 flex items-center gap-2">
                    <span id="avgRating">0.0</span>
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                    </svg>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">5-Star Reviews</div>
                <div class="text-3xl font-bold text-green-600" id="fiveStarCount">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-1">Low Ratings (1-2★)</div>
                <div class="text-3xl font-bold text-red-600" id="lowRatingCount">0</div>
            </div>
        </div>

        <!-- Rating Distribution Chart -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Rating Distribution</h2>
            <div class="space-y-3">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-600 w-16">5 Stars</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                        <div id="bar5" class="bg-green-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <span id="count5" class="text-sm font-medium text-gray-700 w-12 text-right">0</span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-600 w-16">4 Stars</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                        <div id="bar4" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <span id="count4" class="text-sm font-medium text-gray-700 w-12 text-right">0</span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-600 w-16">3 Stars</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                        <div id="bar3" class="bg-yellow-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <span id="count3" class="text-sm font-medium text-gray-700 w-12 text-right">0</span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-600 w-16">2 Stars</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                        <div id="bar2" class="bg-orange-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <span id="count2" class="text-sm font-medium text-gray-700 w-12 text-right">0</span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-600 w-16">1 Star</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                        <div id="bar1" class="bg-red-500 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <span id="count1" class="text-sm font-medium text-gray-700 w-12 text-right">0</span>
                </div>
            </div>
        </div>

        <!-- Reviews Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">All Reviews</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Review</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI Summary</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recommended Action</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Reviews will be populated by JS -->
                    </tbody>
                </table>
            </div>
            <div id="loadingSpinner" class="text-center py-12">
                <svg class="w-8 h-8 animate-spin mx-auto text-indigo-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-gray-600 mt-4">Loading reviews...</p>
            </div>
            <div id="emptyState" class="hidden text-center py-12">
                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <p class="text-gray-600">No reviews yet</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000'; // Change to your deployed backend URL
        let autoRefreshInterval;

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function renderStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                const color = i <= rating ? 'text-yellow-400' : 'text-gray-300';
                stars += `<svg class="w-5 h-5 inline ${color}" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                </svg>`;
            }
            return stars;
        }

        function getRatingColor(rating) {
            if (rating >= 4) return 'bg-green-100 text-green-800';
            if (rating === 3) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        async function loadAnalytics() {
            try {
                const response = await fetch(`${API_URL}/api/analytics`);
                const data = await response.json();

                document.getElementById('totalReviews').textContent = data.total_reviews;
                document.getElementById('avgRating').textContent = data.average_rating.toFixed(1);
                document.getElementById('fiveStarCount').textContent = data.rating_distribution['5'];
                document.getElementById('lowRatingCount').textContent = 
                    parseInt(data.rating_distribution['1']) + parseInt(data.rating_distribution['2']);

                // Update rating distribution bars
                const maxCount = Math.max(...Object.values(data.rating_distribution));
                for (let i = 1; i <= 5; i++) {
                    const count = data.rating_distribution[i.toString()];
                    const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                    document.getElementById(`bar${i}`).style.width = `${percentage}%`;
                    document.getElementById(`count${i}`).textContent = count;
                }
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        async function loadReviews() {
            const tableBody = document.getElementById('reviewsTable');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const emptyState = document.getElementById('emptyState');

            loadingSpinner.classList.remove('hidden');
            emptyState.classList.add('hidden');
            tableBody.innerHTML = '';

            try {
                const response = await fetch(`${API_URL}/api/reviews`);
                const reviews = await response.json();

                loadingSpinner.classList.add('hidden');

                if (reviews.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }

                reviews.forEach(review => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            ${formatDate(review.created_at)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${getRatingColor(review.rating)}">
                                ${review.rating}★
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-800 max-w-xs">
                            <div class="line-clamp-3">${review.review_text || '<em class="text-gray-400">No review text</em>'}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700 max-w-xs">
                            <div class="line-clamp-3">${review.ai_summary}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700 max-w-md">
                            <div class="whitespace-pre-line">${review.recommended_action}</div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Failed to load reviews:', error);
                loadingSpinner.classList.add('hidden');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-red-600">
                            Failed to load reviews. Please check your connection.
                        </td>
                    </tr>
                `;
            }
        }

        async function refreshDashboard() {
            await Promise.all([loadAnalytics(), loadReviews()]);
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', refreshDashboard);

        // Auto-refresh every 30 seconds
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(refreshDashboard, 30000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // Stop auto-refresh when tab is not visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                refreshDashboard();
                startAutoRefresh();
            }
        });

        // Initial load
        refreshDashboard();
        startAutoRefresh();
    </script>
</body>
</html>